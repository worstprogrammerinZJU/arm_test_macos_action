# .github/workflows/asm-test.yml
name: Test macOS ARM Assembly

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-assembly:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install QEMU and verify
      run: |
        brew install qemu
        echo "=== 检查 QEMU 安装 ==="
        
        # 检查可能的 QEMU 可执行文件
        echo "QEMU 可执行文件:"
        ls /opt/homebrew/bin/qemu-* 2>/dev/null || echo "Homebrew 目录未找到"
        ls /usr/local/bin/qemu-* 2>/dev/null || echo "usr/local 目录未找到"
        
        # 检查特定架构
        which qemu-aarch64 || echo "qemu-aarch64 未找到"
        which qemu-system-aarch64 || echo "qemu-system-aarch64 未找到"
        
        # 尝试使用找到的 QEMU
        /opt/homebrew/bin/qemu-system-aarch64 --version || echo "无法运行系统模拟器"
    
    - name: Check QEMU functionality
      run: |
        echo "=== 测试 QEMU 功能 ==="
        # 测试 QEMU 是否能正常运行
        qemu-aarch64 -cpu help | head -5 || echo "QEMU 功能测试失败"
        echo "✅ QEMU 功能正常"
    
    - name: Display environment info
      run: |
        echo "=== 环境信息 ==="
        uname -a
        sw_vers
        echo ""
        echo "=== 工具版本 ==="
        which clang
        clang --version
        echo ""
        echo "=== 汇编文件 ==="
        find . -name "*.s" -o -name "*.S" | head -10
    
    - name: Run the Python test script
      run: |
        echo "=== 运行测试脚本 ==="
        chmod +x batch_test_new.py
        python3 batch_test_new.py . --verbose
    
    - name: Check results
      if: always()
      run: |
        echo "=== 检查结果 ==="
        if [ -d "test_output_macos" ]; then
          echo "✅ 输出目录存在"
          ls -la test_output_macos/
        else
          echo "❌ 输出目录不存在"
        fi
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: test_output_macos/
        retention-days: 7
      continue-on-error: true
